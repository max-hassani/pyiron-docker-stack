jobs:
  include:
    - stage: Build Docker Images
      name: docker
      sudo: required
      services:
        - docker
      language: generic
      install:
        - export TODAY=$(date +%F)
        - docker build -t pyiron/base:latest pyiron-base/
        - docker tag pyiron/base:latest pyiron/base:"$TODAY"
        - docker build -t pyiron/atomistic:latest pyiron-atomistic/
        - docker tag pyiron/atomistic:latest pyiron/atomistic:"$TODAY"
        - docker build -t pyiron/md:latest pyiron-md/
        - docker tag pyiron/md:latest pyiron/pyiron-md-image:"$TODAY"
        - docker build -t pyiron/sphinx:latest pyiron-sphinxdft/
        - docker tag pyiron/sphinx:latest pyiron/sphinx:"$TODAY"
        - docker build -t pyiron/dft:latest pyiron-dft/
        - docker tag pyiron/dft:latest pyiron/dft:"$TODAY"
        - docker build -t pyiron/pyiron:latest pyiron/
        - docker tag pyiron/pyiron:latest pyiron/pyiron:"$TODAY"
        - docker images
      script: 
        - docker run --rm pyiron/base /bin/bash -c 'for f in $(ls ~/*.ipynb); do jupyter nbconvert --ExecutePreprocessor.timeout=9999999 --to notebook --execute $f; done;'
        - docker run --rm pyiron/atomistic /bin/bash -c 'for f in $(ls ~/*.ipynb); do jupyter nbconvert --ExecutePreprocessor.timeout=9999999 --to notebook --execute $f; done;'
        - docker run --rm pyiron/md /bin/bash -c 'for f in $(ls ~/*.ipynb); do jupyter nbconvert --ExecutePreprocessor.timeout=9999999 --to notebook --execute $f; done;'
        - docker run --rm pyiron/sphinx /bin/bash -c 'for f in $(ls ~/*.ipynb); do jupyter nbconvert --ExecutePreprocessor.timeout=9999999 --to notebook --execute $f; done;'
        - docker run --rm pyiron/dft /bin/bash -c 'for f in $(ls ~/*.ipynb); do jupyter nbconvert --ExecutePreprocessor.timeout=9999999 --to notebook --execute $f; done;'
        - docker run --rm pyiron/pyiron /bin/bash -c 'for f in $(ls ~/*.ipynb); do jupyter nbconvert --ExecutePreprocessor.timeout=9999999 --to notebook --execute $f; done;'
      deploy:
        - provider: script
          skip_cleanup: true
          script: ./.ci_support/deploy.sh
          on:
             all_branches: true
             repo: pyiron/pyiron
